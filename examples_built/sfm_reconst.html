<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Dipy &mdash; dipy 0.10.0dev documentation</title>
    
    <link rel="stylesheet" href="../_static/dipy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.10.0dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="dipy 0.10.0dev documentation" href="../index.html" />
  <meta name="keywords" content="dipy, dMRI, DTI, DSI, diffusion MRI, Tensor,
  neuroimaging, python, neuroscience, Eleftherios, Garyfallidis, tractography,
  streamlines, fiber tracking">

  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
 <a href="../index.html">
  <img src="../_static/dipy-banner.png" alt="dipy logo"  border="0" />
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="../index.html">Home</a> |&nbsp;</li>
  <li><a href="../stateoftheart.html">Overview</a> |&nbsp;</li>
  <li><a href="../examples_index.html">Gallery</a> |&nbsp;</li>
  <li><a href="../installation.html">Download</a> |&nbsp;</li>
  <li><a href="../subscribe.html">Subscribe</a> |&nbsp;</li>
  <li><a href="../developers.html">Developers</a> |&nbsp;</li>
  <li><a href="../cite.html">Cite</a> &nbsp;</li>
 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">

  
<h4> Site Navigation </h4>
  <ul>
    <li><a href="../documentation.html">Documentation</a></li>
    <li><a href="../devel/index.html">Development</a></li>
  </ul>

<h4> NIPY Community </h4>
  <ul class="simple">
    <li><a class="reference external"
	href="http://nipy.org/">Community Home</a></li>
    <li><a class="reference external"
	href="http://nipy.org/software/projects/">NIPY Projects</a></li>
    <li><a class="reference external"
	href="http://mail.scipy.org/mailman/listinfo/nipy-devel">Mailing List</a></li>
    <li><a class="reference external"
	href="http://nipy.org/software/license/index.html">License</a></li>
  </ul>


  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Reconstruction with the Sparse Fascicle Model</a><ul>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/examples_built/sfm_reconst.txt"
           rel="nofollow">Show Source</a></li>
  </ul>

<div id="searchbox-ml" style="display: none">
  <h3>Search mailing list archive</h3>
  <script type="text/javascript">
    function mlsearch(curobj)
    {
    curobj.q.value="site:mail.scipy.org/pipermail/nipy-devel/ "+curobj.userquery.value
    }
  </script>
  <form action="http://www.google.com/search" method="get" onSubmit="mlsearch(this)">
    <input name="userquery" size="13" type="text" /> <input type="submit" value="Go" />
    <input name="q" type="hidden" />
  </form>
</div>
  
<div id="searchbox-site" style="display: none">
  <h3>Search this site</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="13" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    </p>
</div>
<script type="text/javascript">$('#searchbox-ml').show(0);</script>
<script type="text/javascript">$('#searchbox-site').show(0);</script>


        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="reconstruction-with-the-sparse-fascicle-model">
<span id="sfm-reconst"></span><span id="example-sfm-reconst"></span><h1>Reconstruction with the Sparse Fascicle Model<a class="headerlink" href="#reconstruction-with-the-sparse-fascicle-model" title="Permalink to this headline">¶</a></h1>
<p>In this example, we will use the Sparse Fascicle Model <a class="reference internal" href="../reference/dipy.reconst.html#rokem2014" id="id1">[Rokem2014]</a>, to
reconstruct the fiber orientation distribution function (fODF) in every voxel.</p>
<p>First, we import the modules we will use in this example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">dipy.reconst.sfm</span> <span class="kn">as</span> <span class="nn">sfm</span>
<span class="kn">import</span> <span class="nn">dipy.data</span> <span class="kn">as</span> <span class="nn">dpd</span>
<span class="kn">import</span> <span class="nn">dipy.reconst.peaks</span> <span class="kn">as</span> <span class="nn">dpp</span>
<span class="kn">from</span> <span class="nn">dipy.viz</span> <span class="kn">import</span> <span class="n">fvtk</span>
</pre></div>
</div>
<p>For the purpose of this example, we will use the Stanford HARDI dataset (150
directions, single b-value of 2000 s/mm:math:<cite>^2</cite>) that can be automatically
downloaded. If you have not yet downloaded this data-set in one of the other
examples, you will need to be connected to the internet the first time you run
this example. The data will be stored for subsequent runs, and for use with
other examples.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.data</span> <span class="kn">import</span> <span class="n">read_stanford_hardi</span>
<span class="n">img</span><span class="p">,</span> <span class="n">gtab</span> <span class="o">=</span> <span class="n">read_stanford_hardi</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
</pre></div>
</div>
<p>Reconstruction of the fiber ODF in each voxel guides subsequent tracking
steps. Here, the model is the Sparse Fascicle Model, described in
<a class="reference internal" href="../reference/dipy.reconst.html#rokem2014" id="id2">[Rokem2014]</a>. This model reconstructs the diffusion signal as a combination of
the signals from different fascicles. This model can be written as:</p>
<div class="math">
<p><span class="math">y = X\beta</span></p>
</div><p>Where <span class="math">y</span> is the signal and <span class="math">\beta</span> are weights on different points in the
sphere. The columns of the design matrix, <span class="math">X</span> are the signals in each point in
the measurement that would be predicted if there was a fascicle oriented in the
direction represented by that column. Typically, the signal used for this
kernel will be a prolate tensor with axial diffusivity 3-5 times higher than
its radial diffusivity. The exact numbers can also be estimated from examining
parts of the brain in which there is known to be only one fascicle (e.g. in
corpus callosum).</p>
<p>Sparsity constraints on the fiber ODF (<span class="math">\beta</span>) are set through the Elastic Net
algorihtm <a class="reference internal" href="../reference/dipy.reconst.html#zou2005" id="id3">[Zou2005]</a>.</p>
<p>Elastic Net optimizes the following cost function:</p>
<div class="math">
<p><span class="math">\sum_{i=1}^{n}{(y_i - \hat{y}_i)^2} + \alpha (\lambda \sum_{j=1}^{m}{w_j}+(1-\lambda) \sum_{j=1}^{m}{w^2_j}</span></p>
</div><p>where <span class="math">\hat{y}</span> is the signal predicted for a particular setting of <span class="math">\beta</span>,
such that the left part of this expression is the squared loss function;
<span class="math">\alpha</span> is a parameter that sets the balance between the squared loss on
the data, and the regularization constraints. The regularization parameter
<span class="math">\lambda</span> sets the <cite>l1_ratio</cite>, which controls the balance between L1-sparsity
(low sum of weights), and low L2-sparsity (low sum-of-squares of the weights).</p>
<p>Just like constrained spherical deconvolution (see <a class="reference internal" href="reconst_csd.html#reconst-csd"><em>Reconstruction with Constrained Spherical Deconvolution</em></a>), the SFM
requires the definition of a response function. We&#8217;ll take advantage of the
automated algorithm in the <tt class="xref py py-mod docutils literal"><span class="pre">csdeconv</span></tt> module to find this response
function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.reconst.csdeconv</span> <span class="kn">import</span> <span class="n">auto_response</span>
<span class="n">response</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">auto_response</span><span class="p">(</span><span class="n">gtab</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">roi_radius</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fa_thr</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">response</span></tt> return value contains two entries. The first is an array with
the eigenvalues of the response function and the second is the average S0 for
this response.</p>
<p>It is a very good practice to always validate the result of auto_response. For,
this purpose we can print it and have a look at its values.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</div>
<p>(array([ 0.0014,  0.00029,  0.00029]), 416.206)</p>
<p>We initialize an SFM model object, using these values. We will use the default
sphere (362  vertices, symmetrically distributed on the surface of the sphere),
as a set of putative fascicle directions that are considered in the model</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sphere</span> <span class="o">=</span> <span class="n">dpd</span><span class="o">.</span><span class="n">get_sphere</span><span class="p">()</span>
<span class="n">sf_model</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">SparseFascicleModel</span><span class="p">(</span><span class="n">gtab</span><span class="p">,</span> <span class="n">sphere</span><span class="o">=</span><span class="n">sphere</span><span class="p">,</span>
                                   <span class="n">l1_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                                   <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>For the purpose of the example, we will consider a small volume of data
containing parts of the corpus callosum and of the centrum semiovale</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data_small</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span> <span class="mi">55</span><span class="p">:</span><span class="mi">85</span><span class="p">,</span> <span class="mi">38</span><span class="p">:</span><span class="mi">39</span><span class="p">]</span>
</pre></div>
</div>
<p>Fitting the model to this small volume of data, we calculate the ODF of this
model on the sphere, and plot it.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sf_fit</span> <span class="o">=</span> <span class="n">sf_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_small</span><span class="p">)</span>
<span class="n">sf_odf</span> <span class="o">=</span> <span class="n">sf_fit</span><span class="o">.</span><span class="n">odf</span><span class="p">(</span><span class="n">sphere</span><span class="p">)</span>

<span class="n">fodf_spheres</span> <span class="o">=</span> <span class="n">fvtk</span><span class="o">.</span><span class="n">sphere_funcs</span><span class="p">(</span><span class="n">sf_odf</span><span class="p">,</span> <span class="n">sphere</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">ren</span> <span class="o">=</span> <span class="n">fvtk</span><span class="o">.</span><span class="n">ren</span><span class="p">()</span>
<span class="n">fvtk</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ren</span><span class="p">,</span> <span class="n">fodf_spheres</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">&#39;Saving illustration as sf_odfs.png&#39;</span><span class="p">)</span>
<span class="n">fvtk</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">ren</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="s">&#39;sf_odfs.png&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
<p>We can extract the peaks from the ODF, and plot these as well</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sf_peaks</span> <span class="o">=</span> <span class="n">dpp</span><span class="o">.</span><span class="n">peaks_from_model</span><span class="p">(</span><span class="n">sf_model</span><span class="p">,</span>
                                <span class="n">data_small</span><span class="p">,</span>
                                <span class="n">sphere</span><span class="p">,</span>
                                <span class="n">relative_peak_threshold</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
                                <span class="n">min_separation_angle</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                <span class="n">return_sh</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="n">fvtk</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">ren</span><span class="p">)</span>
<span class="n">fodf_peaks</span> <span class="o">=</span> <span class="n">fvtk</span><span class="o">.</span><span class="n">peaks</span><span class="p">(</span><span class="n">sf_peaks</span><span class="o">.</span><span class="n">peak_dirs</span><span class="p">,</span> <span class="n">sf_peaks</span><span class="o">.</span><span class="n">peak_values</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.3</span><span class="p">)</span>
<span class="n">fvtk</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ren</span><span class="p">,</span> <span class="n">fodf_peaks</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">&#39;Saving illustration as sf_peaks.png&#39;</span><span class="p">)</span>
<span class="n">fvtk</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">ren</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="s">&#39;sf_peaks.png&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
<p>Finally, we plot both the peaks and the ODFs, overlayed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">fodf_spheres</span><span class="o">.</span><span class="n">GetProperty</span><span class="p">()</span><span class="o">.</span><span class="n">SetOpacity</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">fvtk</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ren</span><span class="p">,</span> <span class="n">fodf_spheres</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">&#39;Saving illustration as sf_both.png&#39;</span><span class="p">)</span>
<span class="n">fvtk</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">ren</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="s">&#39;sf_both.png&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
<div class="figure align-center">
<img alt="../_images/sf_both.png" src="../_images/sf_both.png" />
<p class="caption"><strong>SFM Peaks and ODFs</strong>.</p>
</div>
<p>To see how to use this information in tracking, proceed to <a class="reference internal" href="sfm_tracking.html#sfm-track"><em>Tracking with the Sparse Fascicle Model</em></a>.</p>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<table class="docutils citation" frame="void" id="rokem2014" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[Rokem2014]</td><td><em>(<a class="fn-backref" href="#id1">1</a>, <a class="fn-backref" href="#id2">2</a>)</em> Ariel Rokem, Jason D. Yeatman, Franco Pestilli, Kendrick
N. Kay, Aviv Mezer, Stefan van der Walt, Brian A. Wandell
(2014). Evaluating the accuracy of diffusion MRI models in white
matter. <a class="reference external" href="http://arxiv.org/abs/1411.0721">http://arxiv.org/abs/1411.0721</a></td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="zou2005" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[Zou2005]</a></td><td>Zou H, Hastie T (2005). Regularization and variable
selection via the elastic net. J R Stat Soc B:301-320</td></tr>
</tbody>
</table>
<div class="admonition-example-source-code admonition">
<p class="first admonition-title">Example source code</p>
<p class="last">You can download <a class="reference download internal" href="../_downloads/sfm_reconst.py"><tt class="xref download docutils literal"><span class="pre">the</span> <span class="pre">full</span> <span class="pre">source</span> <span class="pre">code</span> <span class="pre">of</span> <span class="pre">this</span> <span class="pre">example</span></tt></a>.
This same script is also included in the dipy source distribution under the
<tt class="file docutils literal"><span class="pre">doc/examples/</span></tt> directory.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="../index.html">Home</a> |&nbsp;</li>
  <li><a href="../stateoftheart.html">Overview</a> |&nbsp;</li>
  <li><a href="../examples_index.html">Gallery</a> |&nbsp;</li>
  <li><a href="../installation.html">Download</a> |&nbsp;</li>
  <li><a href="../subscribe.html">Subscribe</a> |&nbsp;</li>
  <li><a href="../developers.html">Developers</a> |&nbsp;</li>
  <li><a href="../cite.html">Cite</a> &nbsp;</li>
 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2008-2015, dipy developers &lt;nipy-devel@neuroimaging.scipy.org&gt;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>