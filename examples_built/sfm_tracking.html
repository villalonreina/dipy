<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Dipy &mdash; dipy 0.10.0dev documentation</title>
    
    <link rel="stylesheet" href="../_static/dipy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.10.0dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="dipy 0.10.0dev documentation" href="../index.html" />
  <meta name="keywords" content="dipy, dMRI, DTI, DSI, diffusion MRI, Tensor,
  neuroimaging, python, neuroscience, Eleftherios, Garyfallidis, tractography,
  streamlines, fiber tracking">

  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
 <a href="../index.html">
  <img src="../_static/dipy-banner.png" alt="dipy logo"  border="0" />
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="../index.html">Home</a> |&nbsp;</li>
  <li><a href="../stateoftheart.html">Overview</a> |&nbsp;</li>
  <li><a href="../examples_index.html">Gallery</a> |&nbsp;</li>
  <li><a href="../installation.html">Download</a> |&nbsp;</li>
  <li><a href="../subscribe.html">Subscribe</a> |&nbsp;</li>
  <li><a href="../developers.html">Developers</a> |&nbsp;</li>
  <li><a href="../cite.html">Cite</a> &nbsp;</li>
 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">

  
<h4> Site Navigation </h4>
  <ul>
    <li><a href="../documentation.html">Documentation</a></li>
    <li><a href="../devel/index.html">Development</a></li>
  </ul>

<h4> NIPY Community </h4>
  <ul class="simple">
    <li><a class="reference external"
	href="http://nipy.org/">Community Home</a></li>
    <li><a class="reference external"
	href="http://nipy.org/software/projects/">NIPY Projects</a></li>
    <li><a class="reference external"
	href="http://mail.scipy.org/mailman/listinfo/nipy-devel">Mailing List</a></li>
    <li><a class="reference external"
	href="http://nipy.org/software/license/index.html">License</a></li>
  </ul>


  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tracking with the Sparse Fascicle Model</a><ul>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/examples_built/sfm_tracking.txt"
           rel="nofollow">Show Source</a></li>
  </ul>

<div id="searchbox-ml" style="display: none">
  <h3>Search mailing list archive</h3>
  <script type="text/javascript">
    function mlsearch(curobj)
    {
    curobj.q.value="site:mail.scipy.org/pipermail/nipy-devel/ "+curobj.userquery.value
    }
  </script>
  <form action="http://www.google.com/search" method="get" onSubmit="mlsearch(this)">
    <input name="userquery" size="13" type="text" /> <input type="submit" value="Go" />
    <input name="q" type="hidden" />
  </form>
</div>
  
<div id="searchbox-site" style="display: none">
  <h3>Search this site</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="13" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    </p>
</div>
<script type="text/javascript">$('#searchbox-ml').show(0);</script>
<script type="text/javascript">$('#searchbox-site').show(0);</script>


        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="tracking-with-the-sparse-fascicle-model">
<span id="sfm-track"></span><span id="example-sfm-tracking"></span><h1>Tracking with the Sparse Fascicle Model<a class="headerlink" href="#tracking-with-the-sparse-fascicle-model" title="Permalink to this headline">¶</a></h1>
<p>Tracking requires a per-voxel model. Here, the model is the Sparse Fascicle
Model, described in <a class="reference internal" href="../reference/dipy.reconst.html#rokem2014" id="id1">[Rokem2014]</a>. This model reconstructs the diffusion signal
as a combination of the signals from different fascicles (see also
<a class="reference internal" href="sfm_reconst.html#sfm-reconst"><em>Reconstruction with the Sparse Fascicle Model</em></a>).</p>
<p>To begin, we read the Stanford HARDI data-set into memory:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.data</span> <span class="kn">import</span> <span class="n">read_stanford_labels</span>
<span class="n">hardi_img</span><span class="p">,</span> <span class="n">gtab</span><span class="p">,</span> <span class="n">labels_img</span> <span class="o">=</span> <span class="n">read_stanford_labels</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">hardi_img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">labels_img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
<span class="n">affine</span> <span class="o">=</span> <span class="n">hardi_img</span><span class="o">.</span><span class="n">get_affine</span><span class="p">()</span>
</pre></div>
</div>
<p>This dataset provides a label map (generated using Freesurfer), in which the
white matter voxels are labeled as either 1 or 2:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">white_matter</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>The first step in tracking is generating a model from which tracking directions
can be extracted in every voxel.</p>
<p>For the SFM, this requires first that we define a canonical response function
that will be used to deconvolve the signal in every voxel</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.reconst.csdeconv</span> <span class="kn">import</span> <span class="n">auto_response</span>
<span class="n">response</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">auto_response</span><span class="p">(</span><span class="n">gtab</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">roi_radius</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fa_thr</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</pre></div>
</div>
<p>We initialize an SFM model object, using this response function and using the
default sphere (362  vertices, symmetrically distributed on the surface of the
sphere):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.data</span> <span class="kn">import</span> <span class="n">get_sphere</span>
<span class="n">sphere</span> <span class="o">=</span> <span class="n">get_sphere</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">dipy.reconst</span> <span class="kn">import</span> <span class="n">sfm</span>
<span class="n">sf_model</span> <span class="o">=</span> <span class="n">sfm</span><span class="o">.</span><span class="n">SparseFascicleModel</span><span class="p">(</span><span class="n">gtab</span><span class="p">,</span> <span class="n">sphere</span><span class="o">=</span><span class="n">sphere</span><span class="p">,</span>
                                   <span class="n">l1_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                                   <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>We fit this model to the data in each voxel in the white-matter mask, so that
we can use these directions in tracking:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.reconst.peaks</span> <span class="kn">import</span> <span class="n">peaks_from_model</span>

<span class="n">pnm</span> <span class="o">=</span> <span class="n">peaks_from_model</span><span class="p">(</span><span class="n">sf_model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sphere</span><span class="p">,</span>
                       <span class="n">relative_peak_threshold</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
                       <span class="n">min_separation_angle</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                       <span class="n">mask</span><span class="o">=</span><span class="n">white_matter</span><span class="p">,</span>
                       <span class="n">parallel</span><span class="o">=</span><span class="bp">True</span>
                       <span class="p">)</span>
</pre></div>
</div>
<p>A ThresholdTissueClassifier object is used to segment the data to track only
through areas in which the Generalized Fractional Anisotropy (GFA) is
sufficiently high.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.tracking.local</span> <span class="kn">import</span> <span class="n">ThresholdTissueClassifier</span>
<span class="n">classifier</span> <span class="o">=</span> <span class="n">ThresholdTissueClassifier</span><span class="p">(</span><span class="n">pnm</span><span class="o">.</span><span class="n">gfa</span><span class="p">,</span> <span class="o">.</span><span class="mi">25</span><span class="p">)</span>
</pre></div>
</div>
<p>Tracking will be started from a set of seeds evenly distributed in the white
matter:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.tracking</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">seeds_from_mask</span><span class="p">(</span><span class="n">white_matter</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">affine</span><span class="o">=</span><span class="n">affine</span><span class="p">)</span>
</pre></div>
</div>
<p>For the sake of brevity, we will take only the first 1000 seeds, generating
only 1000 streamlines. Remove this line to track from many more points in all of
the white matter</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">seeds</span> <span class="o">=</span> <span class="n">seeds</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
</pre></div>
</div>
<p>We now have the necessary components to construct a tracking pipeline and
execute the tracking</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.tracking.local</span> <span class="kn">import</span> <span class="n">LocalTracking</span>
<span class="n">streamlines</span> <span class="o">=</span> <span class="n">LocalTracking</span><span class="p">(</span><span class="n">pnm</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">seeds</span><span class="p">,</span> <span class="n">affine</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>

<span class="n">streamlines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">streamlines</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we will create a visualization of these streamlines, relative to this
subject&#8217;s T1-weighted anatomy:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.viz</span> <span class="kn">import</span> <span class="n">fvtk</span>
<span class="kn">from</span> <span class="nn">dipy.viz.colormap</span> <span class="kn">import</span> <span class="n">line_colors</span>
<span class="kn">from</span> <span class="nn">dipy.data</span> <span class="kn">import</span> <span class="n">read_stanford_t1</span>
<span class="kn">from</span> <span class="nn">dipy.tracking.utils</span> <span class="kn">import</span> <span class="n">move_streamlines</span>
<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">inv</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">read_stanford_t1</span><span class="p">()</span>
<span class="n">t1_data</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
<span class="n">t1_aff</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">get_affine</span><span class="p">()</span>
<span class="n">color</span> <span class="o">=</span> <span class="n">line_colors</span><span class="p">(</span><span class="n">streamlines</span><span class="p">)</span>
</pre></div>
</div>
<p>To speed up visualization, we will select a random sub-set of streamlines to
display. This is particularly important, if you track from seeds throughout the
entire white matter, generating many streamlines. In this case, for
demonstration purposes, we subselect 900 streamlines.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.tracking.streamline</span> <span class="kn">import</span> <span class="n">select_random_set_of_streamlines</span>
<span class="n">plot_streamlines</span> <span class="o">=</span> <span class="n">select_random_set_of_streamlines</span><span class="p">(</span><span class="n">streamlines</span><span class="p">,</span> <span class="mi">900</span><span class="p">)</span>

<span class="n">streamlines_actor</span> <span class="o">=</span> <span class="n">fvtk</span><span class="o">.</span><span class="n">streamtube</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">move_streamlines</span><span class="p">(</span><span class="n">plot_streamlines</span><span class="p">,</span> <span class="n">inv</span><span class="p">(</span><span class="n">t1_aff</span><span class="p">))),</span>
                                    <span class="n">line_colors</span><span class="p">(</span><span class="n">streamlines</span><span class="p">))</span>

<span class="n">vol_actor</span> <span class="o">=</span> <span class="n">fvtk</span><span class="o">.</span><span class="n">slicer</span><span class="p">(</span><span class="n">t1_data</span><span class="p">,</span> <span class="n">voxsz</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">plane_i</span><span class="o">=</span><span class="p">[</span><span class="mi">40</span><span class="p">],</span>
                        <span class="n">plane_j</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">plane_k</span><span class="o">=</span><span class="p">[</span><span class="mi">35</span><span class="p">],</span> <span class="n">outline</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">ren</span> <span class="o">=</span> <span class="n">fvtk</span><span class="o">.</span><span class="n">ren</span><span class="p">()</span>
<span class="n">fvtk</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ren</span><span class="p">,</span> <span class="n">streamlines_actor</span><span class="p">)</span>
<span class="n">fvtk</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ren</span><span class="p">,</span> <span class="n">vol_actor</span><span class="p">)</span>
<span class="n">fvtk</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">ren</span><span class="p">,</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="s">&#39;sfm_streamlines.png&#39;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">))</span>
</pre></div>
</div>
<div class="figure align-center">
<img alt="../_images/sfm_streamlines.png" src="../_images/sfm_streamlines.png" />
<p class="caption"><strong>Sparse Fascicle Model tracks</strong></p>
</div>
<p>Finally, we can save these streamlines to a &#8216;trk&#8217; file, for use in other
software, or for further analysis.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">dipy.io.trackvis</span> <span class="kn">import</span> <span class="n">save_trk</span>
<span class="n">save_trk</span><span class="p">(</span><span class="s">&quot;sfm_detr.trk&quot;</span><span class="p">,</span> <span class="n">streamlines</span><span class="p">,</span> <span class="n">affine</span><span class="p">,</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<table class="docutils citation" frame="void" id="rokem2014" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[Rokem2014]</a></td><td>Ariel Rokem, Jason D. Yeatman, Franco Pestilli, Kendrick
N. Kay, Aviv Mezer, Stefan van der Walt, Brian A. Wandell
(2014). Evaluating the accuracy of diffusion MRI models in white
matter. <a class="reference external" href="http://arxiv.org/abs/1411.0721">http://arxiv.org/abs/1411.0721</a></td></tr>
</tbody>
</table>
<div class="admonition-example-source-code admonition">
<p class="first admonition-title">Example source code</p>
<p class="last">You can download <a class="reference download internal" href="../_downloads/sfm_tracking.py"><tt class="xref download docutils literal"><span class="pre">the</span> <span class="pre">full</span> <span class="pre">source</span> <span class="pre">code</span> <span class="pre">of</span> <span class="pre">this</span> <span class="pre">example</span></tt></a>.
This same script is also included in the dipy source distribution under the
<tt class="file docutils literal"><span class="pre">doc/examples/</span></tt> directory.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="../index.html">Home</a> |&nbsp;</li>
  <li><a href="../stateoftheart.html">Overview</a> |&nbsp;</li>
  <li><a href="../examples_index.html">Gallery</a> |&nbsp;</li>
  <li><a href="../installation.html">Download</a> |&nbsp;</li>
  <li><a href="../subscribe.html">Subscribe</a> |&nbsp;</li>
  <li><a href="../developers.html">Developers</a> |&nbsp;</li>
  <li><a href="../cite.html">Cite</a> &nbsp;</li>
 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2008-2015, dipy developers &lt;nipy-devel@neuroimaging.scipy.org&gt;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>