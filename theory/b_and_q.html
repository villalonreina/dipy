<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Dipy &mdash; dipy 0.10.0dev documentation</title>
    
    <link rel="stylesheet" href="../_static/dipy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.10.0dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="dipy 0.10.0dev documentation" href="../index.html" />
  <meta name="keywords" content="dipy, dMRI, DTI, DSI, diffusion MRI, Tensor,
  neuroimaging, python, neuroscience, Eleftherios, Garyfallidis, tractography,
  streamlines, fiber tracking">

  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
 <a href="../index.html">
  <img src="../_static/dipy-banner.png" alt="dipy logo"  border="0" />
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="../index.html">Home</a> |&nbsp;</li>
  <li><a href="../stateoftheart.html">Overview</a> |&nbsp;</li>
  <li><a href="../examples_index.html">Gallery</a> |&nbsp;</li>
  <li><a href="../installation.html">Download</a> |&nbsp;</li>
  <li><a href="../subscribe.html">Subscribe</a> |&nbsp;</li>
  <li><a href="../developers.html">Developers</a> |&nbsp;</li>
  <li><a href="../cite.html">Cite</a> &nbsp;</li>
 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">

  
<h4> Site Navigation </h4>
  <ul>
    <li><a href="../documentation.html">Documentation</a></li>
    <li><a href="../devel/index.html">Development</a></li>
  </ul>

<h4> NIPY Community </h4>
  <ul class="simple">
    <li><a class="reference external"
	href="http://nipy.org/">Community Home</a></li>
    <li><a class="reference external"
	href="http://nipy.org/software/projects/">NIPY Projects</a></li>
    <li><a class="reference external"
	href="http://mail.scipy.org/mailman/listinfo/nipy-devel">Mailing List</a></li>
    <li><a class="reference external"
	href="http://nipy.org/software/license/index.html">License</a></li>
  </ul>


  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">DIY Stuff about b and q</a></li>
<li><a class="reference internal" href="#the-b-matrix-and-siemens-dicom">The B matrix and Siemens DICOM</a></li>
<li><a class="reference internal" href="#and-what-about-q">... and what about &#8216;q&#8217;?</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/theory/b_and_q.txt"
           rel="nofollow">Show Source</a></li>
  </ul>

<div id="searchbox-ml" style="display: none">
  <h3>Search mailing list archive</h3>
  <script type="text/javascript">
    function mlsearch(curobj)
    {
    curobj.q.value="site:mail.scipy.org/pipermail/nipy-devel/ "+curobj.userquery.value
    }
  </script>
  <form action="http://www.google.com/search" method="get" onSubmit="mlsearch(this)">
    <input name="userquery" size="13" type="text" /> <input type="submit" value="Go" />
    <input name="q" type="hidden" />
  </form>
</div>
  
<div id="searchbox-site" style="display: none">
  <h3>Search this site</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="13" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    </p>
</div>
<script type="text/javascript">$('#searchbox-ml').show(0);</script>
<script type="text/javascript">$('#searchbox-site').show(0);</script>


        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="diy-stuff-about-b-and-q">
<span id="b-and-q"></span><h1>DIY Stuff about b and q<a class="headerlink" href="#diy-stuff-about-b-and-q" title="Permalink to this headline">¶</a></h1>
<p>This is a short note to explain the nature of the <tt class="docutils literal"><span class="pre">B_matrix</span></tt> found in the
Siemens private (CSA) fields of the DICOM headers of a diffusion weighted
acquisition.  We trying to explain the relationship between the <tt class="docutils literal"><span class="pre">B_matrix</span></tt> and
the <em>b value</em> and the <em>gradient vector</em>.  The acquisition is made with a planned
(requested) <span class="math">b</span>-value - say <span class="math">b_{req} = 1000</span>, and with a requested gradient
direction <span class="math">\mathbf{g}_{req} = [g_x, g_y, g_z]</span> (supposedly a unit vector) and
peak amplitude <span class="math">G</span>. When the sequence runs the gradient is modulated by an
amplitude envelope <span class="math">\rho(t)</span> with <span class="math">\max |\rho(t)| = 1</span> so that the time course
of the gradient is <span class="math">G\rho(t)\mathbf{g}.</span> <span class="math">G</span> is measured in units of <span class="math">T
\mathrm{mm}^-1.</span> This leads to an important temporal weighting parameter of the
acquisition:</p>
<div class="math">
<p><span class="math">R   =  \int_0^T ( \int_0^t \rho ( \tau ) \, d{ \tau } )^2 \, d{t}.</span></p>
</div><p>(See Basser, Matiello and LeBihan, 1994.) Another formulation involves
the introduction of <cite>k-space</cite>. In standard in-plane MR image encoding</p>
<div class="math">
<p><span class="math">\mathbf{k} = \gamma \int \mathbf{g}(t)dt.</span></p>
</div><p>For the classical Stejskal and Tanner pulsed gradient spin echo (PGSE)
paradigm where two rectangular pulses of width <span class="math">\delta</span> seconds are
spaced with their onsets <span class="math">\Delta</span> seconds apart <span class="math">R = \Delta
(\Delta-\delta/3)^2.</span> The units of <span class="math">R</span> are <span class="math">s^3</span>. The <span class="math">b</span>-matrix has
entries</p>
<div class="math">
<p><span class="math">b_{ij} = \gamma^2 G^2 g_i g_j R,</span></p>
</div><p>where <span class="math">\gamma</span> is the gyromagnetic radius (units
<span class="math">\mathrm{radians}.\mathrm{seconds}^{-1}.T^{-1}</span>) and <span class="math">i</span> and <span class="math">j</span> are
axis direcrtions from <span class="math">x,y,z</span> . The units of the B-matrix are
<span class="math">\mathrm{radians}^2 . \mathrm{seconds} .  \mathrm{mm}^{-2}.</span></p>
<div class="math">
<p><span class="math">\mathbf{B} = \gamma^2 G^2 R \mathbf{g} \mathbf{g}^T.</span></p>
</div><p>The b-value for the acquisition is the trace of <span class="math">\mathbf{B}</span> and is
given by</p>
<div class="math">
<p><span class="math">b = \gamma^2 G^2 R \|\mathbf{g}\|^2 = \gamma^2 G^2 R.</span></p>
</div></div>
<div class="section" id="the-b-matrix-and-siemens-dicom">
<h1>The B matrix and Siemens DICOM<a class="headerlink" href="#the-b-matrix-and-siemens-dicom" title="Permalink to this headline">¶</a></h1>
<p>Though the Stejskal and Tanner formula is available for the classic
PGSE sequence, a different sequence may be used (e.g. TRSE on Siemens
Trio), and anyway the ramps up and down on the gradient field will not
be rectangular. The Siemens scanner software calculates the actual
values of the <span class="math">b_{ij}</span> by numerical integration of the formula above
for <span class="math">R</span>. These values are in the form of the 6 &#8216;B-matrix&#8217; values
<span class="math">[b_{xx}, b_{xy}, b_{xz}, b_{yy}, b_{yz}, b_{zz}]</span>.</p>
<p>In this form they are suitable for use in a least squares estimation of
the diffusion tensor via the equations across the set of acquisitions:</p>
<div class="math">
<p><span class="math">\log(A(\mathbf{q})/A(0)) = -(b_{xx}D_{xx} + 2b_{xy}D_{xy} + 2b_{xz}D_{xz} + \
   b_{yy}D_{yy} + 2b_{yz}D_{yz} + b_{zz}D_{zz})</span></p>
</div><p>The gradient field typically stays in the one gradient direction, in
this case the relationship between <span class="math">b</span>, <span class="math">\mathbf{g}</span> and the <span class="math">b_{ij}</span> is as
follows. If we fill out the symmetric B-matrix as:</p>
<div class="math">
<p><span class="math">\mathbf{B} = \begin{pmatrix}
              b_{xx} &amp; b_{yx} &amp; b_{yz}\\
              b_{xy} &amp; b_{yy} &amp; b_{xz}\\
              b_{xz} &amp; b_{yz} &amp; b_{zz}
              \end{pmatrix}</span></p>
</div><p>then <span class="math">\mathbf{B}</span> is equal to the rank 1 tensor <span class="math">\gamma^2 G^2 R
\mathbf{g} \mathbf{g}^T</span>. By performing an eigenvalue and
eigenvector decomposition of <span class="math">\mathbf{B}</span> we obtain</p>
<div class="math">
<p><span class="math">\mathbf{B} = \lambda_1\mathbf{v}_1\mathbf{v}_1^T +
             \lambda_2\mathbf{v}_2\mathbf{v}_2^T +
             \lambda_3\mathbf{v}_3\mathbf{v}_3^T,</span></p>
</div><p>where only one of the <span class="math">\lambda_i</span>, say <span class="math">\lambda_1</span>, is (effectively)
non-zero. (Because the gradient is always a multiple of a constant
direction <span class="math">\mathbf{B}</span> is a effectively a rank 1 tensor.) Then
<span class="math">\mathbf{g} = \pm\mathbf{v}_1</span>, and <span class="math">b = \gamma^2 G^2 R =
\lambda_1</span>. The <tt class="docutils literal"><span class="pre">b-vector</span></tt> <span class="math">\mathbf{b}</span> is given by:</p>
<div class="math">
<p><span class="math">\mathbf{b}_{\mathrm{actual}} = \gamma^2 G^2 R \mathbf{g}_{\mathrm{actual}}
 = \lambda_1 \mathbf{v}_1.</span></p>
</div><p>Once we have <span class="math">\mathbf{b}_{actual}</span> we can calculate <span class="math">b_{actual} =
\|\mathbf{b}_{actual}\|</span> and <span class="math">\mathbf{g}_{actual} = \mathbf{b}_{actual}
/ b_{actual}</span>. Various sofware packages (e.g. FSL&#8217;s DFT-DTIFIT) expect
to get N x 3 and N x 1 arrays of <span class="math">\mathbf{g}_{actual}</span> (<tt class="docutils literal"><span class="pre">bvecs</span></tt>) and
<span class="math">b_{actual}</span> values (<tt class="docutils literal"><span class="pre">bvals</span></tt>) as their inputs.</p>
</div>
<div class="section" id="and-what-about-q">
<h1>... and what about &#8216;q&#8217;?<a class="headerlink" href="#and-what-about-q" title="Permalink to this headline">¶</a></h1>
<p>Callaghan, Eccles and Xia (1988) showed that the signal from the
narrow pulse PGSE paradigm measured the Fourier transform of the
diffusion displacement propagator. Propagation space is measured in
displacement per unit time <span class="math">(\mathrm{mm}.\mathrm{seconds}^{-1})</span>. They
named the reciprocal space <tt class="docutils literal"><span class="pre">q-space</span></tt> with units of
<span class="math">\mathrm{seconds}.\mathrm{mm}^{-1}</span>.</p>
<div class="math">
<p><span class="math">q = \gamma \delta G /{2\pi}</span></p>
</div><div class="math">
<p><span class="math">b = 4 \pi^2 q^2 \Delta</span></p>
</div><p>Diffusion spectroscopy measures signal over a wide range of <span class="math">b</span>-values
(or <span class="math">q</span>-values) and diffusion times (<span class="math">\Delta</span>) and performs a <span class="math">q</span>-space
analysis (Fourier transform of the diffusion signal decay).</p>
<p>There remains a bit of mystery as to how <span class="math">\mathbf{q}</span> (as a vector in
<span class="math">q</span>-space) is specified for other paradigms. We think that (a) it only
matters up to a scale factor, and (b) we can loosely identify
<span class="math">\mathbf{q}</span> with <span class="math">b\mathbf{g}</span>, where <span class="math">\mathbf{g}</span> is the unit
vector in the gradient direction.</p>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="../index.html">Home</a> |&nbsp;</li>
  <li><a href="../stateoftheart.html">Overview</a> |&nbsp;</li>
  <li><a href="../examples_index.html">Gallery</a> |&nbsp;</li>
  <li><a href="../installation.html">Download</a> |&nbsp;</li>
  <li><a href="../subscribe.html">Subscribe</a> |&nbsp;</li>
  <li><a href="../developers.html">Developers</a> |&nbsp;</li>
  <li><a href="../cite.html">Cite</a> &nbsp;</li>
 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2008-2015, dipy developers &lt;nipy-devel@neuroimaging.scipy.org&gt;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>